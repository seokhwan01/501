<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Self Driving Car - Control UI</title>
<style>
/* 🎨 다크 테마 전체 스타일 */
:root {
  color-scheme: dark;
}

body {
  background: #111;         /* 전체 배경 */
  color: #eee;              /* 기본 글자색 */
  font-family: sans-serif;  /* 기본 글꼴 */
  margin: 0;
}

/* 📦 메인 컨텐츠 영역 */
.wrap {
  max-width: 900px;
  margin: 1rem auto;
  padding: 0 1rem;
}

/* 🗂 카드 스타일 */
.card {
  background: #1b1b1b;
  border-radius: 12px;
  padding: 1rem;
  margin-bottom: 1rem;
}

/* 제목 */
h2 {
  margin: 0.2rem 0 0.8rem 0;
}

/* 영상 이미지 */
img {
  width: 100%;
  border-radius: 8px;
  display: block;
}

/* 🔘 오른쪽 상단 버튼 영역 */
.top-right {
  position: fixed;
  top: 10px;
  right: 10px;
  display: flex;
  gap: 8px;
  z-index: 10;
}

/* 버튼 공통 */
.btn {
  border: none;
  padding: 8px 14px;
  border-radius: 8px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.35);
  transition: 0.2s ease-in-out;
}

/* 버튼 색상 */
.btn-backward {
  background: #007bff; /* 파랑 */
  color: #fff;
}
.btn-stop {
  background: #d7263d; /* 빨강 */
  color: #fff;
}
.btn-resume {
  background: #2bb673; /* 초록 */
  color: #101010;
}

/* 버튼 hover 효과 */
.btn:hover {
  opacity: 0.85;
}

/* 키보드 단축키 안내 */
kbd {
  background: #222;
  border-radius: 6px;
  padding: 2px 6px;
}

/* 도움말 텍스트 */
.help {
  color: #bbb;
  font-size: 0.9rem;
  margin-top: 0.8rem;
}
</style>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
</head>
<body>
<!-- 🔘 상단 버튼 -->
<div class="top-right">
  <button id="btnBackward" class="btn btn-backward">BACKWARD</button>
  <button id="btnStop" class="btn btn-stop">START</button>
</div>

<!-- 📦 메인 영역 -->
<div class="wrap">
  <div class="card">
    <h2>운전자 시점</h2>
    <!-- 🔥 영상 표시 -->
    <img id="videoStream" src="" alt="Video Stream">

    <div class="help">
      키보드: <kbd>←/→</kbd> 회전, <kbd>↑/↓</kbd> 속도, 
      <kbd>Space</kbd> 정지/재개, <kbd>B</kbd> 후진, <kbd>Q</kbd> 종료
    </div>
  </div>
</div>

<script>
const socket = io();

// 🔥 서버에서 오는 영상 처리
socket.on("video_broadcast", (frameBytes)=>{
  const bytes = new Uint8Array(frameBytes);
  const blob = new Blob([bytes], {type: "image/jpeg"});
  const url = URL.createObjectURL(blob);

  const img = document.getElementById("videoStream");
  img.src = url;

  // 메모리 누수 방지
  img.onload = () => URL.revokeObjectURL(url);
});

// 속도 상태 변수
let currentSpeed = 0;  // 기본값 0

// 키보드 이벤트
window.addEventListener('keydown', (e)=>{
  if(e.key==='q'||e.key==='Q'){ socket.emit("control_cmd", "quit"); }
  else if(e.key==='ArrowRight'){ socket.emit("control_cmd", "turn_right"); }
  else if(e.key==='ArrowLeft'){ socket.emit("control_cmd", "turn_left"); }
  else if(e.key==='ArrowUp'){ currentSpeed += 1; socket.emit("control_cmd", "speed_up"); }
  else if(e.key==='ArrowDown'){ currentSpeed -= 1; socket.emit("control_cmd", "speed_down"); }
  else if(e.key===' '){ e.preventDefault(); socket.emit("control_cmd", "stop_resume"); }
  else if(e.key==='b'||e.key==='B'){ socket.emit("control_cmd", "toggle_backward"); }
});
window.addEventListener('keyup', (e)=>{
  if(e.key==='ArrowRight'||e.key==='ArrowLeft'){ socket.emit("control_cmd", "turn_stop"); }
});
</script>
</body>
</html>
